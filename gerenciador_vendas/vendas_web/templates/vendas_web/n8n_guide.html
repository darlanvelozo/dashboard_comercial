<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de Integra√ß√£o N8N - APIs Dashboard Comercial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #1F3D59, #2a4f73);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        .feature-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            margin-bottom: 1.5rem;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .endpoint-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 6px 6px 0;
        }
        .method-get { border-left-color: #28a745; }
        .method-post { border-left-color: #007bff; }
        .method-put { border-left-color: #ffc107; }
        .method-delete { border-left-color: #dc3545; }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            overflow-x: auto;
        }
        .nav-pills .nav-link.active {
            background-color: #1F3D59;
        }
        .toc {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .flow-step {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .flow-step::before {
            content: attr(data-step);
            position: absolute;
            top: -10px;
            left: 20px;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold">ü§ñ Guia de Integra√ß√£o N8N</h1>
                    <p class="lead">Documenta√ß√£o completa das APIs espec√≠ficas para controle de fluxos de atendimento via N8N</p>
                </div>
                <div class="col-md-4 text-center">
                    <i class="fas fa-robot fa-5x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar com TOC -->
            <div class="col-lg-3">
                <div class="toc">
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link active" href="#overview">üöÄ Vis√£o Geral</a>
                        <a class="nav-link" href="#configuracao">‚öôÔ∏è Configura√ß√£o N8N</a>
                        <a class="nav-link" href="#fluxo-basico">üìã Fluxo B√°sico</a>
                        <a class="nav-link" href="#apis-leads">üë§ APIs de Leads</a>
                        <a class="nav-link" href="#apis-fluxos">üîÑ APIs de Fluxos</a>
                        <a class="nav-link" href="#apis-atendimento">üí¨ APIs de Atendimento</a>
                        <a class="nav-link" href="#controle-fluxo">‚öôÔ∏è Controle de Fluxo</a>
                        <a class="nav-link" href="#exemplo-completo">üéØ Exemplo Completo</a>
                        <a class="nav-link" href="#tratamento-erros">üõ°Ô∏è Tratamento de Erros</a>
                    </nav>
                </div>
            </div>

            <!-- Conte√∫do Principal -->
            <div class="col-lg-9">
                <!-- Overview -->
                <section id="overview" class="mb-5">
                    <h2><i class="fas fa-info-circle text-primary"></i> Vis√£o Geral</h2>
                    <p class="lead">As APIs N8N permitem controle completo dos fluxos de atendimento, desde a cria√ß√£o de leads at√© a finaliza√ß√£o dos atendimentos.</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card feature-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                                    <h5>Gerenciamento de Leads</h5>
                                    <p>Buscar e criar leads automaticamente</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card feature-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-sitemap fa-3x text-success mb-3"></i>
                                    <h5>Controle de Fluxos</h5>
                                    <p>Gerenciar fluxos de atendimento din√¢micos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card feature-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                                    <h5>Rastreamento Completo</h5>
                                    <p>Acompanhar progresso em tempo real</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Configura√ß√£o N8N -->
                <section id="configuracao" class="mb-5">
                    <h2><i class="fas fa-cog text-secondary"></i> Configura√ß√£o N8N</h2>
                    <p class="lead">Configura√ß√µes essenciais para integrar o N8N com o Dashboard Comercial</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-key"></i> Vari√°veis de Ambiente</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Configure estas vari√°veis no N8N:</strong></p>
                                    <div class="code-block">
<pre><code># URL Base da API
BASE_URL=https://seudominio.com

# Credenciais (se necess√°rio)
API_KEY=sua_chave_api_aqui

# Configura√ß√µes de Timeout
REQUEST_TIMEOUT=30000

# Configura√ß√µes de Retry
MAX_RETRIES=3
RETRY_DELAY=5000</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-database"></i> Estrutura de Dados</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Dados principais a armazenar:</strong></p>
                                    <ul>
                                        <li><code>lead_id</code>: ID do lead no sistema</li>
                                        <li><code>fluxo_id</code>: ID do fluxo de atendimento</li>
                                        <li><code>atendimento_id</code>: ID do atendimento ativo</li>
                                        <li><code>questao_atual</code>: √çndice da quest√£o atual</li>
                                        <li><code>total_questoes</code>: Total de quest√µes do fluxo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-shield-alt"></i> Headers de Seguran√ßa</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Headers recomendados para todas as requisi√ß√µes:</strong></p>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
Headers:
  Content-Type: application/json
  User-Agent: N8N-Integration/1.0
  X-Request-Source: n8n
  Authorization: Bearer $env.API_KEY</code></pre>
                            </div>
                            <p><strong>Tratamento de Rate Limiting:</strong></p>
                            <ul>
                                <li>Implementar delays entre requisi√ß√µes (m√≠nimo 1 segundo)</li>
                                <li>Verificar headers de rate limit nas respostas</li>
                                <li>Implementar retry autom√°tico com backoff exponencial</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-clock"></i> Configura√ß√µes de Tempo</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Timeouts Recomendados:</h6>
                                    <ul>
                                        <li><strong>Busca de Lead:</strong> 10 segundos</li>
                                        <li><strong>Cria√ß√£o de Lead:</strong> 15 segundos</li>
                                        <li><strong>In√≠cio de Atendimento:</strong> 20 segundos</li>
                                        <li><strong>Registro de Resposta:</strong> 15 segundos</li>
                                        <li><strong>Consulta de Status:</strong> 10 segundos</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Delays Entre A√ß√µes:</h6>
                                    <ul>
                                        <li><strong>Entre requisi√ß√µes:</strong> 1-2 segundos</li>
                                        <li><strong>Ap√≥s erro:</strong> 5-10 segundos</li>
                                        <li><strong>Retry autom√°tico:</strong> 30 segundos</li>
                                        <li><strong>Timeout de sess√£o:</strong> 30 minutos</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Fluxo B√°sico -->
                <section id="fluxo-basico" class="mb-5">
                    <h2><i class="fas fa-play-circle text-success"></i> Fluxo B√°sico de Uso</h2>
                    <p>Sequ√™ncia t√≠pica de opera√ß√µes para um atendimento completo:</p>
                    
                    <div class="flow-step" data-step="1">
                        <h5><i class="fas fa-search text-primary"></i> Buscar ou Criar Lead</h5>
                        <div class="endpoint-card method-get">
                            <code>GET /api/n8n/lead/buscar/?telefone=5511999887766</code>
                        </div>
                        <p>Se n√£o existir:</p>
                        <div class="endpoint-card method-post">
                            <code>POST /api/n8n/lead/criar/</code>
                        </div>
                    </div>

                    <div class="flow-step" data-step="2">
                        <h5><i class="fas fa-list text-info"></i> Listar Fluxos Dispon√≠veis</h5>
                        <div class="endpoint-card method-get">
                            <code>GET /api/n8n/fluxos/?tipo=vendas</code>
                        </div>
                    </div>

                    <div class="flow-step" data-step="3">
                        <h5><i class="fas fa-play text-success"></i> Iniciar Atendimento</h5>
                        <div class="endpoint-card method-post">
                            <code>POST /api/n8n/atendimento/iniciar/</code>
                        </div>
                    </div>

                    <div class="flow-step" data-step="4">
                        <h5><i class="fas fa-comments text-warning"></i> Loop de Quest√µes</h5>
                        <p>Para cada quest√£o:</p>
                        <div class="endpoint-card method-get">
                            <code>GET /api/n8n/atendimento/{id}/consultar/</code>
                        </div>
                        <div class="endpoint-card method-post">
                            <code>POST /api/n8n/atendimento/{id}/responder/</code>
                        </div>
                        <div class="endpoint-card method-post">
                            <code>POST /api/n8n/atendimento/{id}/avancar/</code>
                        </div>
                    </div>

                    <div class="flow-step" data-step="5">
                        <h5><i class="fas fa-check-circle text-success"></i> Finalizar Atendimento</h5>
                        <div class="endpoint-card method-post">
                            <code>POST /api/n8n/atendimento/{id}/finalizar/</code>
                        </div>
                    </div>
                </section>

                <!-- APIs de Leads -->
                <section id="apis-leads" class="mb-5">
                    <h2><i class="fas fa-user-plus text-primary"></i> APIs de Leads</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-search"></i> Buscar Lead por Telefone</h5>
                        </div>
                        <div class="card-body">
                            <div class="endpoint-card method-get">
                                <strong>GET</strong> <code>/api/n8n/lead/buscar/</code>
                            </div>
                            <p><strong>Par√¢metros:</strong></p>
                            <ul>
                                <li><code>telefone</code> (obrigat√≥rio): N√∫mero do telefone com DDD (ex: 5511999887766)</li>
                            </ul>
                            <p><strong>Exemplo de Request N8N:</strong></p>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/lead/buscar/
Method: GET
Query Parameters:
  telefone: [TELEFONE_CLIENTE]</code></pre>
                            </div>
                            <p><strong>Exemplo de Resposta:</strong></p>
                            <div class="code-block">
<pre><code>{
  "encontrado": true,
  "total_encontrados": 1,
  "leads": [{
    "id": 123,
    "nome_razaosocial": "Jo√£o Silva",
    "email": "joao@email.com",
    "telefone": "5511999887766",
    "origem": "whatsapp",
    "status_api": "pendente",
    "score_qualificacao": 7,
    "total_contatos": 3,
    "total_atendimentos": 1,
    "empresa": "Empresa ABC",
    "valor": 99.90,
    "ativo": true
  }]
}</code></pre>
                            </div>
                            <p><strong>Tratamento N8N:</strong></p>
                            <ul>
                                <li>Se <code>encontrado: true</code> ‚Üí Lead existe, usar <code>leads[0].id</code></li>
                                <li>Se <code>encontrado: false</code> ‚Üí Lead n√£o existe, criar novo</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-user-plus"></i> Criar Lead</h5>
                        </div>
                        <div class="card-body">
                            <div class="endpoint-card method-post">
                                <strong>POST</strong> <code>/api/n8n/lead/criar/</code>
                            </div>
                            <p><strong>Par√¢metros Obrigat√≥rios:</strong></p>
                            <ul>
                                <li><code>nome_razaosocial</code>: Nome completo ou raz√£o social</li>
                                <li><code>telefone</code>: Telefone com DDD (ex: 5511999887766)</li>
                            </ul>
                            <p><strong>Par√¢metros Opcionais:</strong></p>
                            <ul>
                                <li><code>email</code>: Email do cliente</li>
                                <li><code>origem</code>: Origem do lead (whatsapp, site, telefone, etc.)</li>
                                <li><code>empresa</code>: Nome da empresa</li>
                                <li><code>valor</code>: Valor estimado da venda</li>
                                <li><code>observacoes</code>: Observa√ß√µes adicionais</li>
                            </ul>
                            <p><strong>Exemplo de Request N8N:</strong></p>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/lead/criar/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "nome_razaosocial": "[NOME_CLIENTE]",
  "telefone": "[TELEFONE_CLIENTE]",
  "email": "[EMAIL_CLIENTE]",
  "origem": "whatsapp",
  "empresa": "[EMPRESA_CLIENTE]",
  "valor": [VALOR_ESTIMADO],
  "observacoes": "Lead criado via N8N - [OBSERVACOES]"
}</code></pre>
                            </div>
                            <p><strong>Exemplo de Resposta:</strong></p>
                            <div class="code-block">
<pre><code>{
  "success": true,
  "id": 124,
  "lead": {
    "id": 124,
    "nome_razaosocial": "Jo√£o Silva",
    "telefone": "5511999887766",
    "email": "joao@email.com",
    "origem": "whatsapp",
    "status_api": "pendente",
    "ativo": true,
    "data_cadastro": "2024-01-15T10:30:00Z"
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- APIs de Fluxos -->
                <section id="apis-fluxos" class="mb-5">
                    <h2><i class="fas fa-sitemap text-info"></i> APIs de Fluxos</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-list"></i> Listar Fluxos Ativos</h5>
                        </div>
                        <div class="card-body">
                            <div class="endpoint-card method-get">
                                <strong>GET</strong> <code>/api/n8n/fluxos/</code>
                            </div>
                            <p><strong>Par√¢metros opcionais:</strong></p>
                            <ul>
                                <li><code>tipo</code>: Filtrar por tipo (vendas, qualificacao, suporte, etc.)</li>
                                <li><code>ativo</code>: Filtrar por status ativo (true/false)</li>
                                <li><code>search</code>: Buscar por nome ou descri√ß√£o</li>
                            </ul>
                            <p><strong>Exemplo de Request N8N:</strong></p>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/fluxos/
Method: GET
Query Parameters:
  tipo: vendas
  ativo: true</code></pre>
                            </div>
                            <p><strong>Exemplo de Resposta:</strong></p>
                            <div class="code-block">
<pre><code>{
  "fluxos": [{
    "id": 1,
    "nome": "Qualifica√ß√£o de Lead - Internet",
    "descricao": "Fluxo para qualificar leads interessados em planos de internet",
    "tipo_fluxo": "qualificacao",
    "ativo": true,
    "total_questoes": 5,
    "max_tentativas": 3,
    "estatisticas": {
      "total_atendimentos": 150,
      "atendimentos_completados": 120,
      "taxa_completacao": 80.0
    }
  }],
  "total": 1
}</code></pre>
                            </div>
                            <p><strong>Tratamento N8N:</strong></p>
                            <ul>
                                <li>Usar <code>fluxos[0].id</code> para obter o ID do primeiro fluxo</li>
                                <li>Verificar <code>total_questoes</code> para saber quantas quest√µes o fluxo possui</li>
                                <li>Armazenar <code>max_tentativas</code> para controle de tentativas</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- APIs de Atendimento -->
                <section id="apis-atendimento" class="mb-5">
                    <h2><i class="fas fa-comments text-warning"></i> APIs de Atendimento</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-play"></i> Iniciar Atendimento</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/iniciar/</code>
                                    </div>
                                    <p><strong>Par√¢metros Obrigat√≥rios:</strong></p>
                                    <ul>
                                        <li><code>lead_id</code>: ID do lead (obtido da API de busca/cria√ß√£o)</li>
                                        <li><code>fluxo_id</code>: ID do fluxo (obtido da API de fluxos)</li>
                                    </ul>
                                    <p><strong>Par√¢metros Opcionais:</strong></p>
                                    <ul>
                                        <li><code>dispositivo</code>: Tipo de dispositivo (whatsapp, telefone, site)</li>
                                        <li><code>observacoes</code>: Observa√ß√µes iniciais</li>
                                    </ul>
                                    <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/iniciar/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "lead_id": [LEAD_ID],
  "fluxo_id": [FLUXO_ID],
  "dispositivo": "whatsapp",
  "observacoes": "Atendimento iniciado via N8N"
}</code></pre>
                                    </div>
                                    <p><strong>Resposta de Sucesso:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "atendimento_id": 456,
  "status": "iniciado",
  "questao_atual": 1,
  "total_questoes": 5,
  "mensagem": "Atendimento iniciado com sucesso"
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-info-circle"></i> Consultar Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-get">
                                        <strong>GET</strong> <code>/api/n8n/atendimento/{id}/consultar/</code>
                                    </div>
                                    <p><strong>Par√¢metros:</strong></p>
                                    <ul>
                                        <li><code>id</code>: ID do atendimento (obtido ao iniciar)</li>
                                    </ul>
                                    <p><strong>Exemplo de Request N8N:</strong></p>
                                    <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/consultar/
Method: GET</code></pre>
                                    </div>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "id": 456,
  "status": "em_andamento",
  "questao_atual": 2,
  "total_questoes": 5,
  "progresso_percentual": 20,
  "questoes_respondidas": 1,
  "pode_avancar": true,
  "pode_voltar": true,
  "tempo_total": 120,
  "lead": {
    "id": 123,
    "nome": "Jo√£o Silva",
    "telefone": "5511999887766"
  }
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-edit"></i> Registrar Resposta</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/{id}/responder/</code>
                                    </div>
                                    <p><strong>Par√¢metros Obrigat√≥rios:</strong></p>
                                    <ul>
                                        <li><code>resposta</code>: Resposta do cliente</li>
                                        <li><code>indice_questao</code>: √çndice da quest√£o sendo respondida</li>
                                    </ul>
                                    <p><strong>Par√¢metros Opcionais:</strong></p>
                                    <ul>
                                        <li><code>validar</code>: Se deve validar a resposta (true/false)</li>
                                        <li><code>observacoes</code>: Observa√ß√µes sobre a resposta</li>
                                    </ul>
                                    <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/responder/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "resposta": "[RESPOSTA_CLIENTE]",
  "indice_questao": [INDICE_QUESTAO],
  "validar": true,
  "observacoes": "Resposta registrada via N8N"
}</code></pre>
                                    </div>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "resposta_valida": true,
  "mensagem": "Resposta registrada com sucesso",
  "proxima_questao": 3,
  "progresso": 40
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-arrow-right"></i> Avan√ßar Quest√£o</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/{id}/avancar/</code>
                                    </div>
                                    <p><strong>Par√¢metros:</strong></p>
                                    <ul>
                                        <li><code>id</code>: ID do atendimento</li>
                                    </ul>
                                    <p><strong>Exemplo de Request N8N:</strong></p>
                                    <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/avancar/
Method: POST
Headers:
  Content-Type: application/json
Body: {}</code></pre>
                                    </div>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "proxima_questao": 3,
  "status": "em_andamento",
  "progresso_percentual": 40,
  "mensagem": "Avan√ßou para pr√≥xima quest√£o"
}</code></pre>
                                    </div>
                                    <p><strong>Tratamento N8N:</strong></p>
                                    <ul>
                                        <li>Se <code>proxima_questao</code> existe ‚Üí Continuar fluxo</li>
                                        <li>Se <code>status: "completado"</code> ‚Üí Finalizar atendimento</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Controle de Fluxo -->
                <section id="controle-fluxo" class="mb-5">
                    <h2><i class="fas fa-cogs text-secondary"></i> Controle de Fluxo</h2>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-check-circle"></i> Finalizar</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/{id}/finalizar/</code>
                                    </div>
                                    <p><strong>Par√¢metros:</strong></p>
                                    <ul>
                                        <li><code>id</code>: ID do atendimento</li>
                                    </ul>
                                    <p><strong>Body (opcional):</strong></p>
                                    <div class="code-block">
<pre><code>{
  "observacoes": "Atendimento finalizado com sucesso",
  "resultado_final": "cliente_qualificado"
}</code></pre>
                                    </div>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "status": "completado",
  "mensagem": "Atendimento finalizado",
  "score_final": 8.5
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-pause-circle"></i> Pausar</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/{id}/pausar/</code>
                                    </div>
                                    <p><strong>Par√¢metros:</strong></p>
                                    <ul>
                                        <li><code>id</code>: ID do atendimento</li>
                                    </ul>
                                    <p><strong>Body (opcional):</strong></p>
                                    <div class="code-block">
<pre><code>{
  "motivo_pausa": "Cliente solicitou pausa",
  "tempo_estimado": 300
}</code></pre>
                                    </div>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "status": "pausado",
  "mensagem": "Atendimento pausado"
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-play-circle"></i> Retomar</h6>
                                </div>
                                <div class="card-body">
                                    <div class="endpoint-card method-post">
                                        <strong>POST</strong> <code>/api/n8n/atendimento/{id}/retomar/</code>
                                    </div>
                                    <p><strong>Par√¢metros:</strong></p>
                                    <ul>
                                        <li><code>id</code>: ID do atendimento</li>
                                    </ul>
                                    <p><strong>Resposta:</strong></p>
                                    <div class="code-block">
<pre><code>{
  "success": true,
  "status": "em_andamento",
  "mensagem": "Atendimento retomado",
  "questao_atual": 3
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Exemplo Completo -->
                <section id="exemplo-completo" class="mb-5">
                    <h2><i class="fas fa-code text-success"></i> Exemplo Completo</h2>
                    <p>Fluxo completo de um atendimento N8N com todas as etapas:</p>
                    
                    <div class="card">
                        <div class="card-body">
                            <h6><strong>Configura√ß√£o Inicial N8N:</strong></h6>
                            <div class="code-block">
<pre><code>// Vari√°veis de ambiente/configura√ß√£o
base_url: "https://seudominio.com"
telefone_cliente: "5511999887766"
nome_cliente: "Jo√£o Silva"
email_cliente: "joao@email.com"</code></pre>
                            </div>
                            
                            <h6><strong>1. Buscar Lead Existente:</strong></h6>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/lead/buscar/
Method: GET
Query Parameters:
  telefone: [TELEFONE_CLIENTE]

// Tratamento da resposta
if ($json.encontrado == true) {
  lead_id = $json.leads[0].id
  // Continuar para passo 3
} else {
  // Ir para passo 2 (criar lead)
}</code></pre>
                            </div>
                            
                            <h6><strong>2. Criar Lead (se n√£o existir):</strong></h6>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/lead/criar/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "nome_razaosocial": "[NOME_CLIENTE]",
  "telefone": "[TELEFONE_CLIENTE]",
  "email": "[EMAIL_CLIENTE]",
  "origem": "whatsapp",
  "observacoes": "Lead criado via N8N"
}

// Armazenar ID do lead criado
lead_id = $json.id</code></pre>
                            </div>
                            
                            <h6><strong>3. Listar Fluxos Dispon√≠veis:</strong></h6>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/fluxos/
Method: GET
Query Parameters:
  tipo: vendas
  ativo: true

// Armazenar ID do fluxo
fluxo_id = $json.fluxos[0].id
total_questoes = $json.fluxos[0].total_questoes</code></pre>
                            </div>
                            
                            <h6><strong>4. Iniciar Atendimento:</strong></h6>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/iniciar/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "lead_id": [LEAD_ID],
  "fluxo_id": [FLUXO_ID],
  "dispositivo": "whatsapp"
}

// Armazenar ID do atendimento
atendimento_id = $json.atendimento_id</code></pre>
                            </div>
                            
                            <h6><strong>5. Loop Principal - Para Cada Quest√£o:</strong></h6>
                            <div class="code-block">
<pre><code>// Loop N8N (While Loop ou For Loop)
for (questao_atual = 1; questao_atual <= total_questoes; questao_atual++) {
  
  // 5.1. Consultar Status Atual
  GET [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/consultar/
  
  // 5.2. Obter Quest√£o Atual
  questao_atual_obj = $json.questao_atual
  
  // 5.3. Enviar Quest√£o para Cliente (via WhatsApp, etc.)
  // ... l√≥gica de envio da quest√£o ...
  
  // 5.4. Aguardar Resposta do Cliente
  // ... l√≥gica de recebimento da resposta ...
  
  // 5.5. Registrar Resposta
  POST [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/responder/
  Body: {
    "resposta": "[RESPOSTA_CLIENTE]",
    "indice_questao": [QUESTAO_ATUAL],
    "validar": true
  }
  
  // 5.6. Avan√ßar para Pr√≥xima Quest√£o
  POST [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/avancar/
  
  // 5.7. Verificar se finalizou
  if ($json.status == "completado") {
    break; // Sair do loop
  }
}</code></pre>
                            </div>
                            
                            <h6><strong>6. Finalizar Atendimento:</strong></h6>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node
URL: [BASE_URL]/api/n8n/atendimento/[ATENDIMENTO_ID]/finalizar/
Method: POST
Headers:
  Content-Type: application/json
Body:
{
  "observacoes": "Atendimento finalizado com sucesso via N8N",
  "resultado_final": "cliente_qualificado"
}

// Resposta final
{
  "success": true,
  "status": "completado",
  "score_final": 8.5,
  "mensagem": "Atendimento finalizado com sucesso"
}</code></pre>
                            </div>
                            
                            <h6><strong>Tratamento de Erros:</strong></h6>
                            <div class="code-block">
<pre><code>// Em cada etapa, verificar sucesso
if ($json.success == false) {
  // Log do erro
  console.log("Erro:", $json.error)
  
  // Decidir a√ß√£o (retry, pausar, finalizar, etc.)
  if ($json.error.includes("timeout")) {
    // Tentar novamente
  } else if ($json.error.includes("lead_nao_encontrado")) {
    // Criar novo lead
  } else {
    // Finalizar com erro
  }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tratamento de Erros -->
                <section id="tratamento-erros" class="mb-5">
                    <h2><i class="fas fa-shield-alt text-danger"></i> Tratamento de Erros</h2>
                    
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> C√≥digos de Status HTTP</h5>
                        <ul>
                            <li><strong>200:</strong> Sucesso</li>
                            <li><strong>201:</strong> Criado com sucesso</li>
                            <li><strong>400:</strong> Erro de valida√ß√£o/dados inv√°lidos</li>
                            <li><strong>404:</strong> Recurso n√£o encontrado</li>
                            <li><strong>429:</strong> Rate limit excedido</li>
                            <li><strong>500:</strong> Erro interno do servidor</li>
                            <li><strong>503:</strong> Servi√ßo indispon√≠vel</li>
                        </ul>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Erros Comuns</h6>
                                </div>
                                <div class="card-body">
                                    <div class="code-block">
<pre><code>// Erro de valida√ß√£o
{
  "error": "Campo telefone √© obrigat√≥rio",
  "campo": "telefone",
  "tipo": "validacao"
}

// Erro de recurso n√£o encontrado
{
  "error": "Lead n√£o encontrado",
  "telefone": "5511999887766",
  "tipo": "nao_encontrado"
}

// Erro de sistema
{
  "error": "Erro interno do servidor",
  "codigo": "INT_001",
  "tipo": "sistema"
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-redo"></i> Estrat√©gias de Retry</h6>
                                </div>
                                <div class="card-body">
                                    <div class="code-block">
<pre><code>// N8N - L√≥gica de Retry
if ($json.success == false) {
  if ($json.error.includes("timeout") || 
      $json.error.includes("rate_limit")) {
    
    // Aguardar e tentar novamente
    await new Promise(resolve => 
      setTimeout(resolve, 5000)
    );
    
    // Retry autom√°tico
    return retryRequest();
  }
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-tools"></i> Implementa√ß√£o de Retry no N8N</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Configura√ß√£o de Retry Autom√°tico:</strong></p>
                            <div class="code-block">
<pre><code>// N8N HTTP Request Node - Configura√ß√µes
Retry on Fail: true
Max Tries: 3
Wait Between Tries: 5 seconds

// Headers de Retry
X-Retry-Count: [RETRY_COUNT]
X-Retry-After: [RETRY_AFTER]</code></pre>
                            </div>
                            
                            <p><strong>Tratamento de Rate Limiting:</strong></p>
                            <div class="code-block">
<pre><code>// Verificar headers de rate limit
if ($response.headers['x-ratelimit-remaining'] == 0) {
  retry_after = $response.headers['retry-after'] || 60;
  
  // Aguardar tempo especificado
  await new Promise(resolve => 
    setTimeout(resolve, retry_after * 1000)
  );
}</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-bug"></i> Logs e Debugging</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Implementar logs detalhados no N8N:</strong></p>
                            <div class="code-block">
<pre><code>// N8N - Log de cada requisi√ß√£o
console.log("API Request:", {
  url: $json.url,
  method: $json.method,
  body: $json.body,
  timestamp: new Date().toISOString()
});

// Log da resposta
console.log("API Response:", {
  status: $response.status,
  body: $json,
  timestamp: new Date().toISOString()
});</code></pre>
                            </div>
                            
                            <p><strong>Monitoramento de Performance:</strong></p>
                            <ul>
                                <li>Medir tempo de resposta de cada API</li>
                                <li>Contar tentativas de retry por endpoint</li>
                                <li>Monitorar taxa de sucesso vs falha</li>
                                <li>Alertas para falhas consecutivas</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Funcionalidades Importantes -->
                <section class="mb-5">
                    <h2><i class="fas fa-star text-warning"></i> Funcionalidades Importantes</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> Contabiliza√ß√£o Autom√°tica</h6>
                                <p>As quest√µes respondidas s√£o contabilizadas automaticamente, evitando duplica√ß√£o e garantindo progresso preciso.</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-clipboard-list"></i> Logs de Auditoria</h6>
                                <p>Todas as opera√ß√µes s√£o registradas automaticamente para auditoria e debugging.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-shield-alt"></i> Valida√ß√£o Robusta</h6>
                                <p>Respostas s√£o validadas conforme regras definidas nas quest√µes (obrigat√≥rias, formato, tamanho, etc.).</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-primary">
                                <h6><i class="fas fa-chart-line"></i> Tempo Real</h6>
                                <p>Status e progresso s√£o atualizados em tempo real, permitindo acompanhamento preciso.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Dashboard Comercial - APIs N8N. Documenta√ß√£o atualizada.</p>
            <p><a href="/api/docs/" class="text-light">üìñ Documenta√ß√£o Swagger</a> | <a href="/admin/" class="text-light">‚öôÔ∏è Django Admin</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Smooth scrolling para links do TOC
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Atualizar link ativo
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Destacar se√ß√£o ativa durante scroll
        window.addEventListener('scroll', function() {
            let current = '';
            document.querySelectorAll('section[id]').forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (pageYOffset >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });

        // Adicionar tooltips para melhor UX
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(element => {
            new bootstrap.Tooltip(element);
        });
    </script>
</body>
</html>
