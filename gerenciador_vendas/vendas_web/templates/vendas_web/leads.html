{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Leads - Megalink</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8f9fa; color: #333; }
    /* Header (copiado do dashboard1) */
    .header { background: white; border-bottom: 1px solid #e0e0e0; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: visible; }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display:flex; justify-content:space-between; align-items:center; height:64px; }
    .header-left { display:flex; align-items:center; gap:1.5rem; }
    .logo-section { display:flex; align-items:center; gap:.75rem; }
    .logo { width:32px; height:32px; background:#333; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:14px; }
    .logo-text { color:#333; font-size:1.1rem; font-weight:600; }
    .nav-menu { display:flex; align-items:center; gap:0; margin-left:2rem; overflow: visible; }
    .nav-item { position:relative; padding:0 1.5rem; height:64px; display:flex; align-items:center; color:#666; text-decoration:none; font-weight:500; font-size:.9rem; transition:all .2s; border-bottom:3px solid transparent; }

    .nav-item:hover { color:#333; background:#f8f9fa; }
    .nav-item.active { color:#1F3D59; border-bottom-color:#1F3D59; }
    .nav-item i { margin-left:.5rem; font-size:.8rem; }
    
    /* Dropdown Menu */
    .nav-item.has-dropdown { position:relative; display:flex; align-items:center; justify-content:center; }
    .dropdown-menu { position:absolute; top:100%; left:50%; background:white; border:1px solid #e0e0e0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); min-width:220px; z-index:1000; opacity:0; visibility:hidden; transform:translateX(-50%) translateY(-10px); transition:all .2s ease; margin-top:-1px; width:auto; }
    .dropdown-menu.show { opacity:1; visibility:visible; transform:translateX(-50%) translateY(0); }
    .dropdown-item { display:block; padding:.75rem 1rem; color:#333; text-decoration:none; font-size:.9rem; font-weight:500; transition:background-color .2s; }
    .dropdown-item:hover { background-color:#f8f9fa; }
    .dropdown-item.active { color:#1F3D59; background-color:#eef3f7; }
    

    .header-right { display:flex; align-items:center; gap:1rem; }
    .user-section { display:flex; align-items:center; gap:.75rem; padding:.5rem; border-radius:8px; cursor:pointer; transition:background-color .2s; }
    .user-section:hover { background-color:#f5f5f5; }
    .user-avatar { width:32px; height:32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:.8rem; }
    .user-info { display:flex; flex-direction:column; align-items:flex-start; }
    .user-name { color:#333; font-weight:500; font-size:.85rem; }
    .user-company { color:#666; font-size:.75rem; }
    .user-actions { display:flex; align-items:center; gap:.5rem; margin-left:.5rem; }
    .chip-icon { border:none; background:#e8f8f5; color:#2c3e50; border-radius:16px; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; font-weight:600; cursor:pointer; transition: background .2s, transform .1s; }
    .chip-icon:hover { background:#d1f2eb; }
    .chip-icon:active { transform: scale(0.98); }

    /* Página */
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    .title { display:flex; align-items:center; gap:.5rem; }
    .title h1 { font-size:1.5rem; font-weight:700; }
    .actions { display:flex; gap:.5rem; }
    .btn { padding: .6rem 1rem; border:none; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn-primary { background: linear-gradient(135deg, #4facfe, #00f2fe); color:white; }
    .btn-success { background: linear-gradient(135deg, #1F3D59, #2a4f73); color:white; }

    .filters-card, .stats-card, .list-card { background:white; border:1px solid #e0e0e0; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .card-header { background: #fff; padding:1rem 1.25rem; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; border-top-left-radius:14px; border-top-right-radius:14px; }
    
    .filters-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    .filters-content.collapsed { max-height: 0; }
    .filters-content.collapsed .filters-grid, .filters-content.collapsed .filters-actions { display: none; }
    .search { display:flex; gap:.5rem; align-items:center; }
    .search input { padding:.6rem .8rem; border:2px solid #e0e0e0; border-radius:10px; min-width:260px; }
    .search input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1); }

    .filters-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; padding: 1rem 1.25rem; }
    .filters-grid .field label { display:block; color:#666; font-weight:600; font-size:.9rem; margin-bottom:.4rem; }
    .filters-grid .field select, .filters-grid .field input { width:100%; padding:.6rem .8rem; border:2px solid #e0e0e0; border-radius:10px; box-sizing:border-box; height:40px; font-size:.9rem; }
    .filters-actions { display:flex; gap:.5rem; align-items:end; padding: 0 1.25rem 1.25rem; }
    .btn-filter { background:#1F3D59; color:#fff; border:none; padding:.6rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn-clear { background:#eef3f7; color:#1F3D59; border:none; padding:.6rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }

    .stats-grid { display:grid; grid-template-columns: repeat(5, 1fr); gap:1rem; padding:1rem; }
    .stat { background:#fff; border:1px solid #e0e0e0; border-radius:12px; padding:1.25rem; display:flex; align-items:center; gap:1rem; }
    .stat .icon { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; background:linear-gradient(135deg,#667eea,#764ba2); }
    .stat h4 { color:#666; font-weight:600; margin-bottom:.15rem; }
    .stat .value { font-size:1.4rem; font-weight:800; }

    .table-wrap { overflow:auto; padding: 0 2rem; }
    table { width:100%; border-collapse:collapse; }
    thead th { background:#fff; color:#333; padding:.85rem 1rem; text-align:left; font-weight:700; font-size:.85rem; position:sticky; top:0; border-bottom:2px solid #f0f0f0; }
    tbody td { padding:.85rem 1rem; border-bottom:1px solid #eee; background:transparent; font-size:.95rem; }
    tbody tr:hover { background:#f8f9ff; transition:background .2s ease; }

    .chip { background:#eef3f7; color:#1F3D59; border-radius:16px; padding:.25rem .6rem; font-size:.8rem; font-weight:600; display:inline-flex; align-items:center; gap:.35rem; }
    .pill { border-radius:14px; padding:.35rem .6rem; font-weight:600; font-size:.8rem; display:inline-flex; align-items:center; gap:.35rem; }
    .pill-blue { background:#eef3f7; color:#1F3D59; }
    .btn-pill { border:2px solid #e0e0e0; background:#fff; color:#1F3D59; border-radius:10px; padding:.35rem .6rem; cursor:pointer; transition: all 0.3s ease; }
    .btn-pill:hover { border-color:#667eea; background:#667eea; color:#fff; transform: translateY(-1px); }
    .btn-pill.btn-danger { border-color:#e74c3c; color:#e74c3c; }
    .btn-pill.btn-danger:hover { background:#e74c3c; color:#fff; }
    .btn-pill.btn-success { border-color:#27ae60; color:#27ae60; }
    .btn-pill.btn-success:hover { background:#27ae60; color:#fff; }
    .btn-pill.btn-warning { border-color:#f39c12; color:#f39c12; }
    .btn-pill.btn-warning:hover { background:#f39c12; color:#fff; }
    
    .id-badge { width:28px; height:28px; background:#6b7280; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .name-cell { display:flex; align-items:center; gap:.6rem; }
    .avatar { width:36px; height:36px; border-radius:50%; background:#2ecc71; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .link-blue { color:#2a6df4; text-decoration:none; }
    .link-blue:hover { text-decoration: underline; }
    .list-card .card-header { border-bottom:0; padding-left:2rem; padding-right:2rem; }

    .pagination { display:flex; gap:.5rem; justify-content:space-between; align-items:center; padding:1rem 2rem; background:#f8f9fa; border-top:1px solid #e0e0e0; }
    .pagination-info { color:#666; font-size:.9rem; }
    .pagination-controls { display:flex; gap:.5rem; }
    .pagination-controls button { padding:.5rem 1rem; border:2px solid #e0e0e0; background:#fff; border-radius:8px; cursor:pointer; transition: all 0.3s ease; font-size:.9rem; }
    .pagination-controls button.active, .pagination-controls button:hover { border-color:#667eea; background:#667eea; color:#fff; }
    .pagination-controls button:disabled { opacity: 0.5; cursor: not-allowed; background:#f5f5f5; }
    .per-page-selector { display:flex; align-items:center; gap:.5rem; }
    .per-page-selector select { padding:.4rem; border:1px solid #e0e0e0; border-radius:6px; }

    /* Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 2rem; min-width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h3 { margin: 0; color: #333; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    .modal-close:hover { color: #333; }
    .modal-body { margin-bottom: 1.5rem; }
    .modal-footer { display: flex; gap: 0.5rem; justify-content: flex-end; }
    
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .form-field { display: flex; flex-direction: column; }
    .form-field.full-width { grid-column: span 2; }
    .form-field label { font-weight: 600; margin-bottom: 0.5rem; color: #333; }
    .form-field input, .form-field select, .form-field textarea { padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; transition: border-color 0.3s; }
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus { outline: none; border-color: #667eea; }
    .form-field textarea { resize: vertical; min-height: 80px; }

    /* Status badges */
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
    .status-pendente { background: #fff3cd; color: #856404; }
    .status-processado { background: #d1ecf1; color: #0c5460; }
    .status-sucesso { background: #d4edda; color: #155724; }
    .status-erro { background: #f8d7da; color: #721c24; }
    .status-rejeitado { background: #f8d7da; color: #721c24; }

    /* Score display */
    .score-display { display: flex; align-items: center; gap: 0.5rem; }
    .score-bar { width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
    .score-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60); border-radius: 3px; }
    
    /* Action buttons grid */
    .actions-grid { display: flex; gap: 0.3rem; justify-content: center; }

    /* Timeline de histórico */
    .historico-timeline { max-height: 400px; overflow-y: auto; }
    .timeline-item { position: relative; padding-left: 2rem; margin-bottom: 1.5rem; border-left: 2px solid #e0e0e0; }
    .timeline-item:last-child { border-left-color: transparent; }
    .timeline-marker { position: absolute; left: -8px; top: 0; width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; }
    .timeline-marker.inicio { background: #3498db; }
    .timeline-marker.sucesso { background: #27ae60; }
    .timeline-marker.transferencia { background: #f39c12; }
    .timeline-marker.conversao { background: #9b59b6; }
    .timeline-marker.venda { background: #e74c3c; }
    .timeline-marker.problema { background: #95a5a6; }
    .timeline-marker.erro { background: #e74c3c; }
    .timeline-marker.outros { background: #bdc3c7; }
    
    .timeline-content { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; }
    .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .timeline-status { font-weight: 600; }
    .timeline-date { color: #666; font-size: 0.85rem; }
    .timeline-details { font-size: 0.9rem; color: #555; }
    .timeline-meta { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f0f0f0; display: flex; gap: 1rem; font-size: 0.8rem; color: #666; }
    .timeline-transcricao { margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; font-style: italic; }
    .timeline-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .timeline-badge { padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .badge-converteu { background: #d4edda; color: #155724; }
    .badge-venda { background: #f8d7da; color: #721c24; }
    
    /* Loading spinner */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo-section">
          <div class="logo">R</div>
          <div class="logo-text">Megalink</div>
        </div>
        <nav class="nav-menu">
                     <a href="{% url 'vendas_web:dashboard1' %}" class="nav-item">
             Dashboard
           </a>
           <a href="{% url 'vendas_web:leads' %}" class="nav-item active">
             Leads
           </a>
           <a href="{% url 'vendas_web:vendas' %}" class="nav-item">
             Vendas
           </a>
           <a href="#" class="nav-item">Relacionar</a>
                                 <a href="#" class="nav-item has-dropdown" id="analisarMenu">Analisar <i class="fas fa-chevron-down"></i>
              <div class="dropdown-menu" id="analisarDropdown">
                <a href="{% url 'vendas_web:relatorio_leads' %}" class="dropdown-item active">
                  Leads
                </a>
                <a href="#" class="dropdown-item">
                  Atendimentos
                </a>
              </div>
            </a>
        </nav>
      </div>
      <div class="header-right">
        <div class="user-section">
          {% if user.is_authenticated %}
            <div class="user-avatar">{{ user.first_name|first|default:user.username|first|upper }}{{ user.last_name|first|upper|default:"" }}</div>
            <div class="user-info">
              <div class="user-name">{{ user.first_name|default:user.username }} {{ user.last_name|default:"" }}</div>
              <div class="user-company">ConsultePlus</div>
            </div>
          {% else %}
            <div class="user-avatar">?</div>
            <div class="user-info">
              <div class="user-name">Visitante</div>
              <div class="user-company">Não logado</div>
            </div>
          {% endif %}
          <div class="user-actions">
            <button class="chip-icon" title="Notificações"><i class="fas fa-bell"></i></button>
            <button class="chip-icon" title="Configurações"><i class="fas fa-cog"></i></button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Filtros -->
    <div class="filters-card">
      <div class="card-header" style="cursor: pointer;" onclick="toggleFiltros()">
        <div style="display:flex; align-items:center; gap:.5rem;">
          <i class="fas fa-filter" style="color:#1F3D59"></i>
          <strong>Filtros</strong>
          <i class="fas fa-chevron-down" id="filtrosChevron" style="transition: transform 0.3s; margin-left: auto;"></i>
        </div>
      </div>
      <div id="filtrosContent" class="filters-content">
      <div class="filters-grid">
        <div class="field">
          <label>Status API</label>
          <select id="statusFilter"><option value="">Todos</option></select>
        </div>
        <div class="field">
          <label>Origem</label>
          <select id="origemFilter"><option value="">Todos</option></select>
        </div>
        <div class="field">
          <label>Situação</label>
          <select id="ativoFilter">
            <option value="">Todos</option>
            <option value="true">Ativos</option>
            <option value="false">Inativos</option>
          </select>
        </div>
        <div class="field">
          <label>Pesquisar</label>
          <input type="text" id="searchInput" placeholder="Nome, email, telefone, empresa..." />
        </div>
        <div class="field">
          <label>Data Início</label>
          <input type="date" id="dataInicio" />
        </div>
        <div class="field">
          <label>Data Fim</label>
          <input type="date" id="dataFim" />
        </div>

        <div class="field">
          <label>Com Valor</label>
          <select id="valorFilter">
            <option value="">Todos</option>
            <option value="sim">Com valor</option>
            <option value="nao">Sem valor</option>
          </select>
        </div>
      </div>
        <div class="filters-actions">
          <button class="btn-filter" id="btnFiltrar"><i class="fas fa-search"></i> Filtrar</button>
          <button class="btn-clear" id="btnLimpar"><i class="fas fa-times"></i> Limpar</button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-card" style="margin-top:1rem;">
      <div class="card-header">
        <div style="display:flex; align-items:center; gap:.5rem;">
          <i class="fas fa-chart-bar" style="color:#1F3D59"></i>
          <strong>Estatísticas dos Leads</strong>
        </div>
        <div class="actions">
          <button class="btn-success" id="btnNovoLead"><i class="fas fa-plus"></i> Novo Lead</button>
          <button class="btn-primary" id="btnExportar"><i class="fas fa-download"></i> Exportar</button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat">
          <div class="icon"><i class="fas fa-database"></i></div>
          <div>
            <h4>Total de Leads</h4>
            <div class="value" id="statTotal">0</div>
          </div>
        </div>

        <div class="stat">
          <div class="icon" style="background:linear-gradient(135deg,#27ae60,#2ecc71)"><i class="fas fa-chart-line"></i></div>
          <div>
            <h4>Valor Total</h4>
            <div class="value" id="statValorTotal">R$ 0,00</div>
          </div>
        </div>
        <div class="stat">
          <div class="icon" style="background:linear-gradient(135deg,#e74c3c,#c0392b)"><i class="fas fa-exclamation-triangle"></i></div>
          <div>
            <h4>Com Erro</h4>
            <div class="value" id="statErros">0</div>
          </div>
        </div>

        <div class="stat">
          <div class="icon" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)"><i class="fas fa-calendar-day"></i></div>
          <div>
            <h4>Hoje</h4>
            <div class="value" id="statHoje">0</div>
          </div>
        </div>
        <div class="stat">
          <div class="icon" style="background:linear-gradient(135deg,#3498db,#2980b9)"><i class="fas fa-calendar-week"></i></div>
          <div>
            <h4>Esta Semana</h4>
            <div class="value" id="statSemana">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="list-card" style="margin-top:1rem;">
      <div class="card-header">
        <div style="display:flex; align-items:center; gap:.5rem;">
          <i class="fas fa-list"></i>
          <strong>Leads</strong>
        </div>
        <div class="chip" id="contadorChip">0 registro(s)</div>
      </div>

      <div class="table-wrap">
        <table id="leadsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Lead</th>
              <th>Contato</th>
              <th>Valor</th>
              <th>Origem</th>
              <th>Status</th>
              <th>Data</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="pagination-info">
          <span id="paginationInfo">Mostrando 0 de 0 registros</span>
        </div>
        <div class="pagination-controls" id="paginationControls"></div>
        <div class="per-page-selector">
          <span>Por página:</span>
          <select id="perPageSelect">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Visualizar/Editar Lead -->
  <div id="modalLead" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Detalhes do Lead</h3>
        <button class="modal-close" onclick="fecharModal('modalLead')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formLead" class="form-grid">
          <div class="form-field">
            <label>Nome/Razão Social *</label>
            <input type="text" id="nome_razaosocial" required>
          </div>
          <div class="form-field">
            <label>Email</label>
            <input type="email" id="email">
          </div>
          <div class="form-field">
            <label>Telefone *</label>
            <input type="text" id="telefone" required>
          </div>
          <div class="form-field">
            <label>Valor (R$)</label>
            <input type="number" step="0.01" id="valor">
          </div>
          <div class="form-field">
            <label>Empresa</label>
            <input type="text" id="empresa">
          </div>
          <div class="form-field">
            <label>CPF/CNPJ</label>
            <input type="text" id="cpf_cnpj">
          </div>
          <div class="form-field">
            <label>Origem</label>
            <select id="origem">
              <option value="site">Site</option>
              <option value="facebook">Facebook</option>
              <option value="instagram">Instagram</option>
              <option value="google">Google Ads</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="indicacao">Indicação</option>
              <option value="telefone">Telefone</option>
              <option value="email">Email</option>
              <option value="outros">Outros</option>
            </select>
          </div>
          <div class="form-field">
            <label>Status API</label>
            <select id="status_api">
              <option value="pendente">Pendente</option>
              <option value="processado">Processado</option>
              <option value="erro">Erro</option>
              <option value="sucesso">Sucesso</option>
              <option value="rejeitado">Rejeitado</option>
            </select>
          </div>
          <div class="form-field">
            <label>Cidade</label>
            <input type="text" id="cidade">
          </div>
          <div class="form-field">
            <label>Estado</label>
            <input type="text" id="estado" maxlength="2">
          </div>
          <div class="form-field">
            <label>CEP</label>
            <input type="text" id="cep">
          </div>
          <div class="form-field">
            <label>Custo de Aquisição (R$)</label>
            <input type="number" step="0.01" id="custo_aquisicao">
          </div>
          <div class="form-field full-width">
            <label>Endereço</label>
            <input type="text" id="endereco">
          </div>
          <div class="form-field full-width">
            <label>Observações</label>
            <textarea id="observacoes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModal('modalLead')">Cancelar</button>
        <button type="button" class="btn btn-success" id="btnSalvarLead">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div id="modalConfirmacao" class="modal">
    <div class="modal-content" style="min-width: 400px;">
      <div class="modal-header">
        <h3>Confirmar Ação</h3>
        <button class="modal-close" onclick="fecharModal('modalConfirmacao')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="mensagemConfirmacao">Tem certeza que deseja realizar esta ação?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModal('modalConfirmacao')">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmar">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Histórico de Contatos -->
  <div id="modalHistorico" class="modal">
    <div class="modal-content" style="min-width: 800px; max-width: 95vw;">
      <div class="modal-header">
        <h3 id="historicoTitle">Histórico de Contatos</h3>
        <button class="modal-close" onclick="fecharModal('modalHistorico')">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Estatísticas do histórico -->
        <div class="historico-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="stat-card" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #1F3D59;" id="statTotalContatos">0</div>
            <div style="font-size: 0.9rem; color: #666;">Total Contatos</div>
          </div>
          <div class="stat-card" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;" id="statConvertidos">0</div>
            <div style="font-size: 0.9rem; color: #666;">Convertidos</div>
          </div>
          <div class="stat-card" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;" id="statVendas">0</div>
            <div style="font-size: 0.9rem; color: #666;">Vendas</div>
          </div>
          <div class="stat-card" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="statTaxaConversao">0%</div>
            <div style="font-size: 0.9rem; color: #666;">Taxa Conversão</div>
          </div>
        </div>

        <!-- Timeline de contatos -->
        <div class="historico-timeline" id="historicoTimeline">
          <div style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
            <div style="margin-top: 1rem;">Carregando histórico...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="fecharModal('modalHistorico')">Fechar</button>
        <button type="button" class="btn btn-primary" id="btnExportarHistorico">Exportar Histórico</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>

  <script>
    const API_LEADS = '{% url "vendas_web:dashboard_leads" %}';
    const API_HISTORICO = '{% url "vendas_web:historico_contatos" %}';
    let page = 1; 
    let perPage = 20;
    let search = ''; 
    let filtros = { 
      origem: '', 
      status: '', 
      ativo: '', 
      data_inicio: '', 
      data_fim: '',
      valor: ''
    };
    let leadEditando = null;

    // Função para toggle dos filtros
    function toggleFiltros() {
      const content = document.getElementById('filtrosContent');
      const chevron = document.getElementById('filtrosChevron');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.style.transform = 'rotate(0deg)';
      } else {
        content.classList.add('collapsed');
        chevron.style.transform = 'rotate(-90deg)';
      }
    }

    // Funções principais
    async function carregarLeads() {
      mostrarLoading(true);
      try {
      const params = new URLSearchParams({ page, per_page: perPage, search, ...filtros });
      const resp = await fetch(`${API_LEADS}?${params}`);
        const data = await resp.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        renderizarTabela(data.leads || []);
        renderPaginacao(data.page || 1, data.pages || 1, data.total || 0);
        popularFiltros(data);
        atualizarStats(data);
        
      } catch (error) {
        console.error('Erro ao carregar leads:', error);
        mostrarNotificacao('Erro ao carregar leads: ' + error.message, 'erro');
      } finally {
        mostrarLoading(false);
      }
    }

    function renderizarTabela(leads) {
      const tbody = document.querySelector('#leadsTable tbody');
      tbody.innerHTML = '';
      
      if (leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem; color:#666;">Nenhum lead encontrado</td></tr>';
        return;
      }

      leads.forEach(lead => {
        const tr = document.createElement('tr');
        const iniciais = (lead.nome_razaosocial || '?').split(' ').map(p => p[0]).slice(0, 2).join('').toUpperCase();
        
        // Status badge
        const statusClass = getStatusClass(lead.status_api);

        tr.innerHTML = `
          <td>${lead.id}</td>
          <td>
            <div class="name-cell">
              <div class="avatar">${iniciais}</div>
              <div>
                <div style="font-weight:700">${lead.nome_razaosocial}</div>
                <div style="color:#666; font-size:.85rem;">${lead.empresa || 'Sem empresa'}</div>
              </div>
            </div>
          </td>
          <td>
            <div>
              <div>${lead.email || '-'}</div>
              <div><a class="link-blue" href="tel:${lead.telefone}">${lead.telefone}</a></div>
            </div>
          </td>
          <td style="font-weight:600; color:${lead.valor && parseFloat(lead.valor.replace(/[^\d,]/g, '').replace(',', '.')) > 0 ? '#27ae60' : '#666'}">${lead.valor || 'R$ 0,00'}</td>
          <td><span class="pill pill-blue">${lead.origem}</span></td>
          <td><span class="status-badge ${statusClass}">${lead.status_api}</span></td>
          <td>${lead.data_cadastro}</td>
          <td>
            <div class="actions-grid">
              <button class="btn-pill" onclick="visualizarLead(${lead.id})" title="Visualizar">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-pill" onclick="visualizarHistorico(${lead.id}, 'lead')" title="Histórico de Contatos">
                <i class="fas fa-history"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getStatusClass(status) {
      const statusMap = {
        'pendente': 'status-pendente',
        'processado': 'status-processado',
        'sucesso': 'status-sucesso',
        'erro': 'status-erro',
        'rejeitado': 'status-rejeitado'
      };
      return statusMap[status] || 'status-pendente';
    }

    function renderPaginacao(currentPage, totalPages, total = 0) {
      const controls = document.getElementById('paginationControls');
      const info = document.getElementById('paginationInfo');
      
      // Atualizar informações da paginação
      const startItem = (currentPage - 1) * perPage + 1;
      const endItem = Math.min(currentPage * perPage, total);
      info.textContent = `Mostrando ${startItem} a ${endItem} de ${total} registros`;
      
      controls.innerHTML = '';
      
      if (totalPages <= 1) return;

      // Botão anterior
      const prev = document.createElement('button');
      prev.innerHTML = '<i class="fas fa-chevron-left"></i> Anterior';
      prev.disabled = currentPage === 1;
      prev.onclick = () => { page = currentPage - 1; carregarLeads(); };
      controls.appendChild(prev);

      // Primeira página
      if (currentPage > 3) {
        const first = document.createElement('button');
        first.textContent = '1';
        first.onclick = () => { page = 1; carregarLeads(); };
        controls.appendChild(first);
        
        if (currentPage > 4) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '0.5rem';
          dots.style.color = '#666';
          controls.appendChild(dots);
        }
      }

      // Números das páginas
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => { page = i; carregarLeads(); };
        controls.appendChild(btn);
      }

      // Última página
      if (currentPage < totalPages - 2) {
        if (currentPage < totalPages - 3) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '0.5rem';
          dots.style.color = '#666';
          controls.appendChild(dots);
        }
        
        const last = document.createElement('button');
        last.textContent = totalPages;
        last.onclick = () => { page = totalPages; carregarLeads(); };
        controls.appendChild(last);
      }

      // Botão próximo
      const next = document.createElement('button');
      next.innerHTML = 'Próximo <i class="fas fa-chevron-right"></i>';
      next.disabled = currentPage === totalPages;
      next.onclick = () => { page = currentPage + 1; carregarLeads(); };
      controls.appendChild(next);
    }

    function popularFiltros(data) {
      const origemSel = document.getElementById('origemFilter');
      const statusSel = document.getElementById('statusFilter');
      
      if (origemSel.children.length === 1 && data.origemChoices) {
        data.origemChoices.forEach(opcao => {
          const opt = document.createElement('option');
          opt.value = opcao.value;
          opt.textContent = opcao.label;
          origemSel.appendChild(opt);
        });
      }
      
      if (statusSel.children.length === 1 && data.statusChoices) {
        data.statusChoices.forEach(opcao => {
          const opt = document.createElement('option');
          opt.value = opcao.value;
          opt.textContent = opcao.label;
          statusSel.appendChild(opt);
        });
      }
    }

    function atualizarStats(data) {
      document.getElementById('contadorChip').textContent = `${data.total || 0} registro(s)`;
      
      // Stats básicas
      document.getElementById('statTotal').textContent = data.total || 0;
      
      // Usar dados reais quando disponíveis
      const leads = data.leads || [];
      const erros = leads.filter(l => l.status_api === 'erro').length;
      
      document.getElementById('statErros').textContent = erros;
      
      // Calcular valor total
      const valorTotal = leads.reduce((sum, l) => {
        if (l.valor) {
          const valor = parseFloat(l.valor.replace(/[^\d,]/g, '').replace(',', '.'));
          return sum + (isNaN(valor) ? 0 : valor);
        }
        return sum;
      }, 0);
      
      document.getElementById('statValorTotal').textContent = formatarMoeda(valorTotal);
      
      // Stats temporais (estimativa baseada na data)
      const hoje = new Date();
      const hojeStr = hoje.toLocaleDateString('pt-BR');
      const leadsHoje = leads.filter(l => l.data_cadastro && l.data_cadastro.includes(hojeStr)).length;
      
      document.getElementById('statHoje').textContent = leadsHoje;
      document.getElementById('statSemana').textContent = Math.floor(data.total * 0.15); // Estimativa
    }

    // Funções de histórico
    async function visualizarHistorico(id, tipo) {
      try {
        mostrarLoading(true);
        
        // Buscar dados do histórico
        const params = new URLSearchParams();
        if (tipo === 'lead') {
          params.append('lead_id', id);
        } else if (tipo === 'prospecto') {
          params.append('prospecto_id', id);
        }
        
        const response = await fetch(`${API_HISTORICO}?${params}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Erro ao carregar histórico');
        }
        
        // Atualizar modal
        document.getElementById('historicoTitle').textContent = 
          `Histórico de Contatos - ${tipo === 'lead' ? 'Lead' : 'Prospecto'} #${id}`;
        
        // Atualizar estatísticas
        const stats = data.estatisticas;
        document.getElementById('statTotalContatos').textContent = stats.total_contatos;
        document.getElementById('statConvertidos').textContent = stats.contatos_convertidos;
        document.getElementById('statVendas').textContent = stats.vendas_convertidas;
        document.getElementById('statTaxaConversao').textContent = `${stats.taxa_conversao_lead.toFixed(1)}%`;
        
        // Renderizar timeline
        renderizarTimeline(data.historicos);
        
        // Mostrar modal
        document.getElementById('modalHistorico').style.display = 'block';
        
      } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        mostrarNotificacao('Erro ao carregar histórico: ' + error.message, 'erro');
      } finally {
        mostrarLoading(false);
      }
    }

    function renderizarTimeline(historicos) {
      const timeline = document.getElementById('historicoTimeline');
      
      if (historicos.length === 0) {
        timeline.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <div>Nenhum histórico de contato encontrado</div>
          </div>
        `;
        return;
      }
      
      timeline.innerHTML = '';
      
      historicos.forEach((historico, index) => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        const markerClass = `timeline-marker ${historico.status.categoria}`;
        
        // Badges de conversão
        let badges = '';
        if (historico.converteu_lead) {
          badges += '<span class="timeline-badge badge-converteu">Lead Convertido</span>';
        }
        if (historico.converteu_venda) {
          badges += '<span class="timeline-badge badge-venda">Venda Convertida</span>';
        }
        
        // Transcrição
        let transcricaoHtml = '';
        if (historico.transcricao) {
          transcricaoHtml = `<div class="timeline-transcricao">"${historico.transcricao}"</div>`;
        }
        
        item.innerHTML = `
          <div class="${markerClass}"></div>
          <div class="timeline-content">
            <div class="timeline-header">
              <div class="timeline-status">${historico.status.display}</div>
              <div class="timeline-date">${historico.data_hora}</div>
            </div>
            <div class="timeline-details">
              <strong>${historico.nome_contato}</strong> • ${historico.telefone}
            </div>
            ${transcricaoHtml}
            <div class="timeline-meta">
              <span><i class="fas fa-clock"></i> ${historico.duracao}</span>
              ${historico.lead ? `<span><i class="fas fa-user"></i> ${historico.lead.nome}</span>` : ''}
              ${historico.observacoes ? `<span><i class="fas fa-comment"></i> ${historico.observacoes}</span>` : ''}
            </div>
            ${badges ? `<div class="timeline-badges">${badges}</div>` : ''}
          </div>
        `;
        
        timeline.appendChild(item);
      });
    }

    // Funções de ação
    async function visualizarLead(id) {
      try {
        mostrarLoading(true);
        const resp = await fetch(`${API_LEADS}?id=${id}`);
        const data = await resp.json();
        
        if (data.error || !data.leads || data.leads.length === 0) {
          throw new Error('Lead não encontrado');
        }
        
        const lead = data.leads[0];
        preencherFormulario(lead);
        
        // Desabilitar campos no modo visualização
        const inputs = document.querySelectorAll('#formLead input, #formLead select, #formLead textarea');
        inputs.forEach(input => input.disabled = true);
        
        document.getElementById('modalTitle').textContent = 'Visualizar Lead';
        document.getElementById('btnSalvarLead').style.display = 'none';
        document.getElementById('modalLead').style.display = 'block';
        
      } catch (error) {
        mostrarNotificacao('Erro ao carregar lead: ' + error.message, 'erro');
      } finally {
        mostrarLoading(false);
      }
    }



    function novoLead() {
      leadEditando = null;
      limparFormulario();
      
      // Habilitar campos
      const inputs = document.querySelectorAll('#formLead input, #formLead select, #formLead textarea');
      inputs.forEach(input => input.disabled = false);
      
      document.getElementById('modalTitle').textContent = 'Novo Lead';
      document.getElementById('btnSalvarLead').style.display = 'block';
      document.getElementById('modalLead').style.display = 'block';
    }



    async function exportarDados() {
      try {
        mostrarLoading(true);
        // Implementar exportação
        mostrarNotificacao('Funcionalidade de exportação em desenvolvimento', 'info');
      } catch (error) {
        mostrarNotificacao('Erro ao exportar: ' + error.message, 'erro');
      } finally {
        mostrarLoading(false);
      }
    }

    // Funções de formulário
    function preencherFormulario(lead) {
      document.getElementById('nome_razaosocial').value = lead.nome_razaosocial || '';
      document.getElementById('email').value = lead.email || '';
      document.getElementById('telefone').value = lead.telefone || '';
      document.getElementById('valor').value = lead.valor ? lead.valor.replace(/[^\d,]/g, '').replace(',', '.') : '';
      document.getElementById('empresa').value = lead.empresa || '';
      document.getElementById('cpf_cnpj').value = lead.cpf_cnpj || '';
      document.getElementById('origem').value = lead.origem || '';
      document.getElementById('status_api').value = lead.status_api || '';
      document.getElementById('cidade').value = lead.cidade || '';
      document.getElementById('estado').value = lead.estado || '';
      document.getElementById('cep').value = lead.cep || '';
      document.getElementById('custo_aquisicao').value = lead.custo_aquisicao || '';
      document.getElementById('endereco').value = lead.endereco || '';
      document.getElementById('observacoes').value = lead.observacoes || '';
    }

    function limparFormulario() {
      document.getElementById('formLead').reset();
    }

    // Funções utilitárias
    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    function mostrarLoading(mostrar) {
      document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
    }

    function mostrarNotificacao(mensagem, tipo = 'info') {
      // Implementação simples - você pode melhorar com uma biblioteca de toast
      const cor = {
        'sucesso': '#27ae60',
        'erro': '#e74c3c',
        'info': '#3498db',
        'aviso': '#f39c12'
      }[tipo] || '#3498db';
      
      alert(mensagem); // Substituir por toast mais elegante
    }

    function fecharModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      leadEditando = null;
    }

    function confirmarAcao(mensagem, callback) {
      document.getElementById('mensagemConfirmacao').textContent = mensagem;
      document.getElementById('btnConfirmar').onclick = () => {
        fecharModal('modalConfirmacao');
        callback();
      };
      document.getElementById('modalConfirmacao').style.display = 'block';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Filtros
      document.getElementById('searchInput').addEventListener('input', (e) => {
        search = e.target.value;
        page = 1;
        debounceCarregar();
      });

      ['origemFilter', 'statusFilter', 'ativoFilter', 'valorFilter'].forEach(filtroId => {
        document.getElementById(filtroId).addEventListener('change', (e) => {
          const key = filtroId.replace('Filter', '');
          filtros[key] = e.target.value;
          page = 1;
          carregarLeads();
        });
      });

      document.getElementById('dataInicio').addEventListener('change', (e) => {
        filtros.data_inicio = e.target.value;
        page = 1;
        carregarLeads();
      });

      document.getElementById('dataFim').addEventListener('change', (e) => {
        filtros.data_fim = e.target.value;
        page = 1;
        carregarLeads();
      });

      // Botões
      document.getElementById('btnFiltrar').addEventListener('click', () => {
        page = 1;
        carregarLeads();
      });

      document.getElementById('btnLimpar').addEventListener('click', () => {
        search = '';
        filtros = { origem: '', status: '', ativo: '', data_inicio: '', data_fim: '', valor: '' };
        
        document.getElementById('searchInput').value = '';
        document.getElementById('origemFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('ativoFilter').value = '';
        document.getElementById('valorFilter').value = '';
        document.getElementById('dataInicio').value = '';
        document.getElementById('dataFim').value = '';
        
        page = 1;
        carregarLeads();
      });

      document.getElementById('btnNovoLead').addEventListener('click', novoLead);
      document.getElementById('btnExportar').addEventListener('click', exportarDados);

      // Seletor de itens por página
      document.getElementById('perPageSelect').addEventListener('change', (e) => {
        perPage = parseInt(e.target.value);
        page = 1; // Voltar para primeira página
        carregarLeads();
      });

      // Dropdown navigation
       const analisarMenu = document.getElementById('analisarMenu');
       const analisarDropdown = document.getElementById('analisarDropdown');
       let dropdownTimeout;

       if (analisarMenu && analisarDropdown) {
         analisarMenu.addEventListener('mouseenter', () => {
           clearTimeout(dropdownTimeout);
           analisarDropdown.classList.add('show');
         });

         analisarMenu.addEventListener('mouseleave', () => {
           dropdownTimeout = setTimeout(() => {
             analisarDropdown.classList.remove('show');
           }, 200);
         });

         analisarDropdown.addEventListener('mouseenter', () => {
           clearTimeout(dropdownTimeout);
         });

         analisarDropdown.addEventListener('mouseleave', () => {
           dropdownTimeout = setTimeout(() => {
             analisarDropdown.classList.remove('show');
           }, 200);
         });

         document.addEventListener('click', (e) => {
           if (!analisarMenu.contains(e.target) && !analisarDropdown.contains(e.target)) {
             analisarDropdown.classList.remove('show');
           }
         });
       }

      // Modal handlers
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      // Carregar dados iniciais
      carregarLeads();
    });

    // Debounce para busca
    let timeoutBusca;
    function debounceCarregar() {
      clearTimeout(timeoutBusca);
      timeoutBusca = setTimeout(carregarLeads, 400);
    }
    </script>
 </body>
 </html>

